<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-143196276-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-143196276-1');
</script>
        <title>Peter Wooldridge's Blog</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta charset="utf-8" />
        <link href="https://peterwooldridge.me/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Peter Wooldridge's Blog Full Atom Feed" />
        <link href="https://peterwooldridge.me/feeds/diabetes.atom.xml" type="application/atom+xml" rel="alternate" title="Peter Wooldridge's Blog Categories Atom Feed" />
        <!-- twitter card metadata -->
<meta name="twitter:site" content="">
<meta name="twitter:title" content="Creating a local CGM database using with a Pi 4 and Node-RED">
<meta name="twitter:description" content="">
        <!-- OG Tags -->
<meta property="og:url" content="https://peterwooldridge.me/posts/2021/Feb/16/dexcom-download-pt1/"/>
<meta property="og:title" content="Peter Wooldridge's Blog | Creating a local CGM database using with a Pi 4 and Node-RED" />
<meta property="og:description" content="" />
        <!-- favicon -->
        <!-- moment.js for date formatting -->
        <script src="https://peterwooldridge.me/theme/js/moment.js"></script>
        <!-- css -->
        <link rel="stylesheet" type="text/css" href="https://peterwooldridge.me/theme/css/main.css" />
		<script>
			
                /*! grunt-grunticon Stylesheet Loader - v2.1.2 | https://github.com/filamentgroup/grunticon | (c) 2015 Scott Jehl, Filament Group, Inc. | MIT license. */
    
    (function(e){function t(t,n,r,o){"use strict";function a(){for(var e,n=0;u.length>n;n++)u[n].href&&u[n].href.indexOf(t)>-1&&(e=!0);e?i.media=r||"all":setTimeout(a)}var i=e.document.createElement("link"),l=n||e.document.getElementsByTagName("script")[0],u=e.document.styleSheets;return i.rel="stylesheet",i.href=t,i.media="only x",i.onload=o||null,l.parentNode.insertBefore(i,l),a(),i}var n=function(r,o){"use strict";if(r&&3===r.length){var a=e.navigator,i=e.Image,l=!(!document.createElementNS||!document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGRect||!document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#Image","1.1")||e.opera&&-1===a.userAgent.indexOf("Chrome")||-1!==a.userAgent.indexOf("Series40")),u=new i;u.onerror=function(){n.method="png",n.href=r[2],t(r[2])},u.onload=function(){var e=1===u.width&&1===u.height,a=r[e&&l?0:e?1:2];n.method=e&&l?"svg":e?"datapng":"png",n.href=a,t(a,null,null,o)},u.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",document.documentElement.className+=" grunticon"}};n.loadCSS=t,e.grunticon=n})(this);(function(e,t){"use strict";var n=t.document,r="grunticon:",o=function(e){if(n.attachEvent?"complete"===n.readyState:"loading"!==n.readyState)e();else{var t=!1;n.addEventListener("readystatechange",function(){t||(t=!0,e())},!1)}},a=function(e){return t.document.querySelector('link[href$="'+e+'"]')},c=function(e){var t,n,o,a,c,i,u={};if(t=e.sheet,!t)return u;n=t.cssRules?t.cssRules:t.rules;for(var l=0;n.length>l;l++)o=n[l].cssText,a=r+n[l].selectorText,c=o.split(");")[0].match(/US\-ASCII\,([^"']+)/),c&&c[1]&&(i=decodeURIComponent(c[1]),u[a]=i);return u},i=function(e){var t,o,a;o="data-grunticon-embed";for(var c in e)if(a=c.slice(r.length),t=n.querySelectorAll(a+"["+o+"]"),t.length)for(var i=0;t.length>i;i++)t[i].innerHTML=e[c],t[i].style.backgroundImage="none",t[i].removeAttribute(o);return t},u=function(t){"svg"===e.method&&o(function(){i(c(a(e.href))),"function"==typeof t&&t()})};e.embedIcons=i,e.getCSS=a,e.getIcons=c,e.ready=o,e.svgLoadedCallback=u,e.embedSVG=u})(grunticon,this);
                
                grunticon(["https://peterwooldridge.me/theme/css/icons.data.svg.css", "https://peterwooldridge.me/theme/css/icons.data.png.css", "https://peterwooldridge.me/theme/css/icons.fallback.css"]);
            </script>
        <noscript><link href="https://peterwooldridge.me/theme/css/icons.fallback.css" rel="stylesheet"></noscript>
        <!-- menu toggle javascript -->
        <script type="text/javascript">
            document.addEventListener("DOMContentLoaded", initMenu);
            
            function initMenu(){
                var menu = document.getElementById("menu");
                var menulink = document.getElementById("menu-link");
                menulink.addEventListener("click", function toggleMenu(){
                        window.event.preventDefault();
                        menulink.classList.toggle('active');
                        menu.classList.toggle('active');              
                    });
            };
        </script>



</head>
<body>
    <div role="banner" id="masthead">
        <header>
            <h1><a href="/">Peter's Blog</a></h1>
            <a href="#menu" id="menu-link">more stuff</a>
            <nav id="menu">
                <ul>
                        <li><a href="/pages/about.html">About</a></li>
                        <li><a href="/categories">Categories</a></li>
                        <li><a href="/tags">Tags</a></li>
                            <li><a href="https://peterwooldridge.me/category/machine-learning.html">Machine Learning</a></li>
                            <li class="active"><a href="https://peterwooldridge.me/category/diabetes.html">Diabetes</a></li>
                            <li><a href="https://peterwooldridge.me/category/sport.html">Sport</a></li>
                            <li><a href="https://peterwooldridge.me/category/tech.html">Tech</a></li>
                </ul>
            </nav>
        </header>
    </div>
        <div class="page" role="main">
  <div class="article" role="article">
    <article>
        <footer>
            <a name="top"></a>
            <p>
              <time datetime=" 2021-02-16 08:35:00+00:00">
                <script>document.write(moment('2021-02-16 08:35:00+00:00').format('LL'));</script>
              </time>
            </p>
        </footer>
        <header>
          <h2>
            Creating a local CGM database using with a Pi 4 and Node-RED
          </h2>
        </header>
      <div class="content">
         <embed>
  <p align="center">
     <img src="https://peterwooldridge.me/posts/2021/Feb/16/dexcom-download-pt1/node-red.png" alt="Drawing" width="30%"/>
  </p>
  <p align="center">
     <img src="https://peterwooldridge.me/posts/2021/Feb/16/dexcom-download-pt1/dexcom.png" alt="Drawing" width="30%"/>
  </p>
</embed><p>I've been using the Dexcom continuous glucose monitors for about 4 years now. The sensor, currently the G6 model, attaches to my body and transmits glucose readings every 5 mins.
The sensor connects directly with the Dexcom smartphone app and then the data is sent to the Dexcom Share Servers in the cloud.</p>
<p>Dexcom has a web tool called Clarity which lets you view a report related to your CGM data. Dexcom Clarity is useful for exploring glucose data but, I wanted to start building a local copy of my glucose data to:</p>
<ul class="simple">
<li>Have a local backup of all of my glucose readings (Dexcom doesn't offer a download data option and if I change CGM providers I don't want to lose all that useful historic data)</li>
<li>Build custom visualisations that are more relevant to my day-to-day tracking of my diabetes goals (I hope to show some of these in later posts)</li>
<li>See how my control has fluctuated over the years (Clarity only lets me view or compare 90 days at a time)</li>
<li>Combine other data sources so that I can explore how different situations affect my glucose</li>
</ul>
<p>Another tool for exploring glucose data is <a class="reference external" href="https://nightscout.github.io/">Nightscout</a> which I also use extensively. The reports are really useful; the only issue I have is that mongoDB database used in heroku (the cloud hosting platform) has a free tier limit of 512GB which for me gets filled up every few months forcing me to empty the database periodically - another reason for me wanting to creating a local copy.</p>
<div class="section" id="the-setup">
<h2>The Setup</h2>
<p>The setup I've built uses a Raspberry Pi 4 and a software called <a class="reference external" href="https://nodered.org/">Node-RED</a> which comes pre-installed with Raspian. Node-RED is a low-code environment for events driven applications. There are loads of amazing applications of what can be done with this technology.</p>
<p>For this project, I created a simple <cite>flow</cite> in Node-RED that runs a few http requests to authenticate with the Dexcom servers, query my glucose and then finally puts results into a local mysql database running on the pi.</p>
<p>A <cite>flow</cite> is composed of a sequence of nodes that run sequentially and each perform a task. The results of each nodes task is fed into the next connected node till the chain is completed.</p>
<embed>
  <p align="center">
     <img src="https://peterwooldridge.me/posts/2021/Feb/16/dexcom-download-pt1/node-red-flow.png" alt="Drawing" width="100%" caption="sdfsdf"/>
     <figcaption>How flows look in the Node-RED web interface</figcaption>
  </p>
</embed><p>Node-RED makes it really easy to schedule flows to run on a specific schedule. Since the Dexcom CGMs produce a glucose reading every 5 minutes, I set the flow to query the api every 2.5 minutes to ensure the database was topped up with the latest data.</p>
<p>Eventually, hosting the database externally from the pi is probably a better idea as the flash storage on the pi is not ideal for backing up data longterm. That said, to get going quickly and start exploring the data, this was perfect.</p>
<p>For anyone interested in how I built this setup, the following video details the setup step-by-step and, I've also walked through it in the remainder of this post.</p>
<div class="youtube"><iframe src="https://www.youtube.com/embed/GRtUX1Wiqfo" width="512" height="320" allowfullscreen seamless frameBorder="0"></iframe></div><div class="line-block">
<div class="line"><br /></div>
</div>
<p>The remainder of this guide assumes you have a raspberry pi 4 booted and connected up to a display, and a dexcom account with which to pull glucose data from.</p>
</div>
<div class="section" id="setting-up-and-configuring-node-red">
<h2>Setting up and configuring Node-RED</h2>
<p>The Raspian operating system comes with Node-RED pre-installed so there's no installation required here. Node-RED can be started by clicking the <cite>Programming</cite> menu at the top of the screen followed by <cite>Node-RED</cite>. This will launch Node-RED inside a console.</p>
<embed>
  <p align="center">
     <img src="https://peterwooldridge.me/posts/2021/Feb/16/dexcom-download-pt1/node-red-menu.png" alt="Drawing" width="100%"/>
  </p>
</embed><p>The console will contain the url that we can access the web interface to Node-RED from. Once I've found the URL in the console, I can navigate to it using a web browser and connect to the web interface.</p>
<embed>
  <p align="center">
     <img src="https://peterwooldridge.me/posts/2021/Feb/16/dexcom-download-pt1/node-red-url.png" alt="Drawing" width="100%"/>
     <figcaption>The console showing the Node-RED URL</figcaption>
  </p>
</embed><p>Starting Node-RED from the menu bar is perfectly fine but, if I accidentally close the console then it will stop. I'd recommend running Node-RED as a service, so that if the pi reboots it'll get auto-started and run in the background.</p>
<p>Run the following in a terminal to setup the service which will auto-start Node-RED after the next reboot:</p>
<div class="highlight"><pre><span></span>sudo systemctl <span class="nb">enable</span> nodered.service
</pre></div>
<p>The Node-RED flow I built can be found at the following <a class="reference external" href="https://github.com/pwwooldridge/dexcom-to-db">github repo</a>. Flows are defined as json files and my repo contains two: <cite>dexcom-pull-eu.json</cite> and <cite>dexcom-pull-us.json</cite> for those in the EU and US respectively (the dexcom servers endpoints are different, but the flows are pretty much the same). The other difference is that I made the EU flow output glucose data in mmol/L and the US one in mg/dL by default.</p>
<p>To import the flow into Node-RED you can copy and paste the JSON file to the clipboard and then inside the node-RED web interface, press <cite>Ctrl-i</cite> to open up the import flow panel and paste your flow right in.</p>
<p>After the flow is imported, you should see the nodes appear on the canvas. The next thing we need to do is install a couple of extra nodes that I've made use of. Click the 3 horizontal bars in the top right of the Node-RED interface, click <cite>manage palette</cite> and then navigate to the <cite>install</cite> tab. The two nodes that need to be installed are <cite>node-red-contrib-credentials</cite> and <cite>node-red-node-mysql</cite>. Go ahead and type these into the search, find the packages and install them at which point you should see the dashed lines around the outsides of the mysql and credentials nodes fill in on your canvas.</p>
<p>I also made use of an additional nodejs library <cite>sql-template-strings</cite> from inside this flow so I need to install this using npm. To do this, head out of Node-RED and open up a terminal from the <cite>Programming</cite> menu in Raspian. Once you have a terminal open, run the following commands:</p>
<div class="highlight"><pre><span></span><span class="nb">cd</span> ~/.node-red
npm install sql-template-strings
nano settings.js
</pre></div>
<p>The last command will open up a nano text editor that allows you to edit the Node-RED settings file. Once in the settings.js file, scroll down until you see a section like this:</p>
<div class="highlight"><pre><span></span><span class="nx">functionGlobalContext</span><span class="o">:</span> <span class="p">{</span>
    <span class="c1">// os:require(&#39;os&#39;),</span>
    <span class="c1">// jfive:require(&quot;johnny-five&quot;),</span>
    <span class="c1">// j5board:require(&quot;johnny-five&quot;).Board({repl:false})</span>
<span class="p">}</span>
</pre></div>
<p>modify it to looks as follows:</p>
<div class="highlight"><pre><span></span><span class="nx">functionGlobalContext</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">sqlModule</span><span class="o">:</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sql-template-strings&#39;</span><span class="p">)</span>
    <span class="c1">// os:require(&#39;os&#39;),</span>
    <span class="c1">// jfive:require(&quot;johnny-five&quot;),</span>
    <span class="c1">// j5board:require(&quot;johnny-five&quot;).Board({repl:false})</span>
<span class="p">}</span>
</pre></div>
<p>Press <cite>Ctrl+x</cite> to save and come out of nano. To make the setting updates take effect, we need to restart Node-RED which can be done in the terminal as follows:</p>
<div class="highlight"><pre><span></span>sudo service node-red restart
</pre></div>
</div>
<div class="section" id="setting-up-mysql">
<h2>Setting up mysql</h2>
<p>Now we're ready to get our database setup. Note: In Raspian, MariaDB is used as a drop-in replacement to MySQL. All MySQL commands should still work with MariaDB.</p>
<p>We can use the terminal we used earlier to install and configure the database. The first step is to check for any package updates, by running the following:</p>
<div class="highlight"><pre><span></span>sudo apt-get update
sudo apt-get upgrade
</pre></div>
<p>The above may take a while depending on how many updates are needed. After the updates have completed, we're ready to install MariaDB/MySQL with the following command:</p>
<div class="highlight"><pre><span></span>sudo apt-get install mariadb-server
</pre></div>
<p>Once the database is installed the next step is database configuration which involves setting a root password for the database. To start configuration wizard, run:</p>
<div class="highlight"><pre><span></span>sudo mysql_secure_installation
</pre></div>
<p>The <code>mysql_secure_installation</code> will first ask you to set a root password which has to be input twice. For the remaining questions I did:</p>
<ul class="simple">
<li>Press <code>Y</code> to remove anonymous users.</li>
<li>Press <code>Y</code> to disallow root login remotely.</li>
<li>Press <code>Y</code> to remove test database and user.</li>
<li>Press <code>Y</code> to reload privilege tables. (last step)</li>
</ul>
<p>and we're done. We've now set the root password for connecting to our database.</p>
<p>To be able to login with the password we just set, I had to change the database plugin from auth_socket to mysql_native_password. To do this, connect to the MySQL shell using <code>sudo mysql -u root</code>, then run the following to switch the plugin:</p>
<div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">USE</span> <span class="n">mysql</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">UPDATE</span> <span class="k">user</span> <span class="k">SET</span> <span class="n">plugin</span><span class="o">=</span><span class="s1">&#39;mysql_native_password&#39;</span> <span class="k">WHERE</span> <span class="k">User</span><span class="o">=</span><span class="s1">&#39;root&#39;</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">FLUSH</span> <span class="k">PRIVILEGES</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">exit</span><span class="p">;</span>
</pre></div>
<p>In order to make the settings take effect, restart MySQL by running:</p>
<div class="highlight"><pre><span></span>$ sudo service mysql restart
</pre></div>
<p>Now we can connect to our database by using the following command (you'll be required to enter your root password):</p>
<div class="highlight"><pre><span></span>mysql -u root -p
</pre></div>
<p>The above command connects to the mysql database using the command line and allows us to run commands from the prompt directly on the database.</p>
<p>We can use the mysql command line tool to create the database and tables to store the glucose data. First I'll create a database in mysql called <code>glucose</code> and then connect to it.</p>
<div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">create</span> <span class="k">database</span> <span class="n">glucose</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">use</span> <span class="n">glucose</span><span class="p">;</span>
</pre></div>
<p>Once connected, I can create a table to store my glucose data:</p>
<div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">create</span> <span class="k">table</span> <span class="n">glucose</span> <span class="p">(</span>
<span class="n">mysql</span><span class="o">&gt;</span>     <span class="n">date_string</span> <span class="n">datetime</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
<span class="n">mysql</span><span class="o">&gt;</span>     <span class="n">value</span> <span class="nb">float</span><span class="p">,</span>
<span class="n">mysql</span><span class="o">&gt;</span>     <span class="n">direction</span> <span class="nb">text</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="p">);</span>
</pre></div>
<p>Once I've executed this, I can press <cite>Ctrl-d</cite> to exit from the mysql command line and head back to the node-RED web ui for the final setup part.</p>
<p>Okay, we're nearly up and running. Final 3 small bits of setup to do back in Node-RED. First thing we need to do is add our dexcom <cite>accountId</cite> and <cite>password</cite> into the credentials node so that Node-RED can authenticate with dexcom. To do this, double click on the node called <cite>credentials</cite> in your flow and type in your accountId and password.</p>
<embed>
  <p align="center">
     <img src="https://peterwooldridge.me/posts/2021/Feb/16/dexcom-download-pt1/node-red-credentials.png" alt="Drawing" width="100%"/>
  </p>
</embed><p>Next, double click on the orange mysql node called <cite>diabetes</cite>. Similar to the credentials node setup, double click the node, add &quot;root&quot; as the database user and for the password, use the one you setup in the database setup. For the database put &quot;diabetes&quot;. Click done.</p>
<p>The final piece of setup involves setting up the flow to run on a regular repeating schedule. To do this, double click on the blue inject node on the very left-hand side of the flow - the name is usually &quot;timestamp&quot;. Double click it and ensure the &quot;Inject once after&quot; box is unticked and then in the repeat dropdown choose interval and make the frequency 150 seconds. Click done to close the dialog and click the red deploy button in the top right.</p>
<p>The deploy button will launch our flow. Assuming there are no issues upon launching it will continue to run, till we say otherwise. If we've configured everything correctly, we should see in a few minutes time records appearing in the database. Inside the mysql command line, we can check how many records have been created by running:</p>
<div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">use</span> <span class="n">diabetes</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="n">glucose</span><span class="p">;</span>
</pre></div>
<p>This should return a number, hopefully greater than zero, indicating that glucose records are being synced into the database and WE ARE DONE!</p>
<p>Thanks for reading this far! If you try to set this setup up yourself, check out the video where I go into a bit more detail on testing the flow as I go.</p>
</div>

      </div>
      <div class="back-to-top">
          <a href="#top">back to top</a>
      </div>
    </article>
  </div>
<!-- end article -->
                <footer>
                    <div class="icons">
                        <a href="https://github.com/pwwooldridge" target="_blank"><div class="icon-github icon"></div></a>
                        <a href="https://www.strava.com/athletes/1691795" target="_blank"><div class="icon-strava icon"></div></a>
                    </div>
                    <p>© <script>document.write(moment().format('YYYY'));</script> Peter Wooldridge</p>
                </footer>
        </div>
</body>
</html>